name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Clean npm cache
        run: |
          echo "Cleaning npm cache..."
          npm cache clean --force

      - name: Install dependencies
        run: |
          cd apps/web
          echo "Installing dependencies..."
          npm install --no-audit --no-fund --verbose
          echo "Dependencies installed successfully"
          echo "Verifying node_modules..."
          ls -la node_modules/.bin/ | head -20

      - name: Build static site
        run: |
          cd apps/web
          echo "Building static site..."
          npm run build 2>&1 | tee build.log || (echo "Build failed. Last 50 lines:" && tail -50 build.log && exit 1)
          echo "Static build completed"

      - name: Deploy to Cloudflare Pages
        run: |
          cd apps/web
          echo "Deploying static build to Cloudflare Pages..."
          echo "Account ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}"
          ls -la out/
          npx wrangler pages deploy out --compatibility-date=2025-04-01
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Output deployment URL
        run: echo "Deployment completed. Check Cloudflare Pages dashboard for live URL."
